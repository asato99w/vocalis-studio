# MVP仕様書 - Vocalis Studio

## ドキュメント情報
- **作成日**: 2025年10月4日
- **バージョン**: 1.0
- **対象リリース**: v0.1.0（内部テスト版）

## 1. 概要

Vocalis Studio MVPは、ピアノスケール音源を再生しながら歌声を録音できるボイストレーニング補助アプリです。ユーザーは5音階（ドレミファソ）を聴きながら歌い、録音した音声を後で確認することで歌唱練習をサポートします。

## 2. コア機能

### 2.1 スケール音源再生
### 2.2 同時録音機能
### 2.3 録音データの保存と再生

## 3. スケール音源仕様

### 3.1 スケールパターン
- **音階**: ドレミファソ（メジャースケールの最初の5音）
- **MIDI音程**: Root, +2, +4, +5, +7（例: C=60, D=62, E=64, F=65, G=67）
- **再生パターン**: 上昇+下降
  - 9音構成: ド→レ→ミ→ファ→ソ→ファ→ミ→レ→ド
  - 例: C-D-E-F-G-F-E-D-C

### 3.2 ピッチ進行仕様
- **開始音**: C4（Middle C = MIDI 60 = 261.63 Hz）
- **終了音**: C5（Hi-C = MIDI 72 = 523.25 Hz）
- **進行方法**: 半音ずつ上昇（クロマチック進行）
- **繰り返し回数**: 13回（1オクターブ分）

```
1回目:  C4 - D4 - E4 - F4 - G4 - F4 - E4 - D4 - C4
2回目:  C#4 - D#4 - F4 - F#4 - G#4 - F#4 - F4 - D#4 - C#4
3回目:  D4 - E4 - F#4 - G4 - A4 - G4 - F#4 - E4 - D4
...
13回目: C5 - D5 - E5 - F5 - G5 - F5 - E5 - D5 - C5
```

### 3.3 テンポ・演奏スタイル
- **1音の長さ**: 1.0秒
- **演奏スタイル**: レガート（音が途切れずに繋がる）
- **総再生時間**: 117秒（9音 × 13回 × 1秒）
- **再生方法**: 連続自動再生（13回を途切れなく実行）

### 3.4 音源生成技術
- **使用技術**: AVAudioUnitSampler
- **音色**: iOS標準ピアノ音源（General MIDI Piano）
- **サンプルレート**: 44100 Hz
- **チャンネル**: ステレオ（2ch）

## 4. 録音機能仕様

### 4.1 録音フロー

#### ステップ1: 録音開始
- ユーザーが「録音開始」ボタンをタップ
- マイク権限の確認（初回のみ）

#### ステップ2: カウントダウン
- 視覚的カウントダウン表示: 3→2→1
- 各数字を1秒間表示（合計3秒）
- ユーザーが準備する時間を提供

#### ステップ3: 録音+再生開始
- カウントダウン終了後、自動で開始
- スケール音源の再生とマイク録音を同時に開始
- デバイスのスピーカーから再生される音とマイクの音声が両方録音される

#### ステップ4: 進行中
- **進捗表示**:
  - 現在のピッチ番号: "5 / 13"
  - 現在の音階情報: "D4 - E4 - F#4 - G4 - A4"
  - 経過時間: "MM:SS"
- **停止ボタン**: いつでも途中停止可能

#### ステップ5: 終了
- **自動終了**: 13回完了（117秒後）で自動停止
- **手動停止**: 停止ボタンタップで即座に停止
- いずれの場合も録音ファイルを自動保存

### 4.2 録音品質（技術仕様）
- **サンプルレート**: 44100 Hz
- **フォーマット**: AAC（.m4a）
- **チャンネル**: モノラル（1ch）
- **ビットレート**: 128 kbps
- **エンコード品質**: High

### 4.3 録音内容
- **混合音声**: スピーカーからのピアノ音 + マイクからの歌声
- MVPでは分離せず、1つのファイルとして記録

## 5. 録音データ管理仕様

### 5.1 保存仕様

#### ファイル命名規則
- **形式**: `recording_yyyyMMdd_HHmmss.m4a`
- **例**: `recording_20251004_143022.m4a`
- **保存場所**: アプリのDocumentsディレクトリ

#### メタデータ
各録音に以下の情報を紐付けて保存:
- **録音日時**: `Date`型（作成日時）
- **録音時間**: 秒数（Double型）
- **スケール設定**:
  - 開始音: MIDI番号（例: 60 = C4）
  - 終了音: MIDI番号（例: 72 = C5）
  - テンポ: 1音あたりの秒数（例: 1.0）

### 5.2 データ永続化
- **ストレージ**: ローカルストレージ（FileManager）
- **メタデータ管理**: UserDefaults または軽量DB（CoreDataは不使用）
- **将来拡張**: iCloud同期は将来バージョンで検討

## 6. 録音再生機能仕様

### 6.1 録音リスト画面

#### 表示内容
録音リストを新しい順に表示:
- **録音日時**: "2025年10月4日 14:30"
- **録音時間**: "01:57"（MM:SS形式）
- **ファイルサイズ**: オプション（表示してもしなくても可）

#### リスト操作
- **タップ**: 録音を再生
- **スワイプ削除**: 左スワイプで削除ボタン表示
- **並び順**: 新しい順（録音日時降順）

### 6.2 録音再生仕様

#### 再生方法
- **シンプル再生**: 録音ファイルをそのまま再生
- **音源分離なし**: ピアノ音と歌声が混在したまま再生
- **オーディオセッション**: スピーカーから再生

#### 再生コントロール
- **再生/停止**: 基本操作
- **シーク**: MVPでは不要
- **音量調整**: デバイスの音量ボタンに依存（アプリ内UI不要）
- **早送り/巻き戻し**: MVPでは不要

### 6.3 削除機能
- **個別削除**: スワイプまたは削除ボタン
- **確認ダイアログ**: 削除前に確認アラート表示
- **一括削除**: MVPでは不要（将来バージョンで検討）

## 7. 画面構成

### 7.1 画面一覧
1. **メイン画面（録音画面）**: スケール再生+録音を実行
2. **録音リスト画面**: 過去の録音を管理・再生

### 7.2 メイン画面（録音画面）

#### 待機状態
- **タイトル**: "ボイストレーニング"
- **説明文**: "録音ボタンを押して練習を開始"
- **録音開始ボタン**: 大きな目立つボタン
- **録音リストへのナビゲーション**: 右上にリストアイコン

#### カウントダウン状態
- **大きな数字表示**: "3" → "2" → "1"
- **背景色変化**: 視覚的フィードバック
- **キャンセルボタン**: カウントダウン中にキャンセル可能

#### 録音中状態
- **進捗表示**:
  - "ピッチ: 5 / 13"
  - "現在の音階: D4 - E4 - F#4 - G4 - A4"
- **経過時間**: "01:23"
- **プログレスバー**: 全体進捗を視覚化
- **停止ボタン**: 赤色の目立つボタン

#### 完了状態
- **完了メッセージ**: "録音完了！"
- **アクション**:
  - "録音を聴く" → 録音リスト画面へ遷移
  - "もう一度録音" → 待機状態に戻る

### 7.3 録音リスト画面

#### ヘッダー
- **タイトル**: "録音リスト"
- **戻るボタン**: メイン画面に戻る

#### リスト表示
- **空の状態**: "まだ録音がありません"メッセージ
- **リストアイテム**:
  - 録音日時
  - 録音時間
  - 再生アイコン
  - 削除ボタン（スワイプで表示）

#### 再生中
- **再生中インジケーター**: 現在再生中の項目を強調表示
- **停止ボタン**: 再生中のみ表示

## 8. ユーザー権限

### 8.1 マイク権限
- **必須権限**: マイクアクセス
- **リクエストタイミング**: 初回録音開始時
- **Info.plistキー**: `NSMicrophoneUsageDescription`
- **説明文**: "歌声を録音するためにマイクへのアクセスが必要です"

### 8.2 権限拒否時の動作
- **アラート表示**: "マイク権限が必要です"
- **設定へ誘導**: 設定アプリを開くボタン
- **代替動作**: 録音機能は使用不可（スケール再生のみ可能）

## 9. エラーハンドリング

### 9.1 想定されるエラー

#### 録音関連
- **マイク使用不可**: 他のアプリが使用中
- **ストレージ不足**: 録音ファイルを保存できない
- **録音失敗**: AVAudioRecorderの初期化失敗

#### 再生関連
- **ファイル読み込み失敗**: 破損ファイルまたは削除済み
- **再生失敗**: AVAudioPlayerの初期化失敗

### 9.2 エラー表示
- **ユーザーフレンドリーなメッセージ**: 技術用語を避ける
- **アラートダイアログ**: エラー内容と対処方法を表示
- **ログ記録**: デバッグ用にコンソールログ出力

## 10. 非機能要件

### 10.1 パフォーマンス
- **起動時間**: 2秒以内
- **録音開始遅延**: カウントダウン後即座に開始（50ms以内）
- **スケール音源と録音の同期ずれ**: 10ms以内

### 10.2 品質
- **クラッシュ率**: < 0.5%
- **テストカバレッジ**: 80%以上
- **対応デバイス**: iPhone（iOS 15.0以降）

### 10.3 ユーザビリティ
- **直感的操作**: 説明なしで使える
- **即座のフィードバック**: ボタンタップに即反応
- **視覚的ガイド**: 現在の状態が常に明確

## 11. MVP対象外機能（将来バージョン）

以下の機能はMVPには含まず、将来バージョンで検討:

### 11.1 音源関連
- キー（開始音）の選択
- テンポの調整
- 他のスケールパターン（アルペジオ、マイナースケールなど）
- スケール音源のみの再生（録音なし）

### 11.2 録音関連
- 音源と歌声の分離録音
- リアルタイムピッチ検出
- 波形表示
- メトロノーム機能

### 11.3 データ管理
- 録音の名前変更
- タグ・カテゴリ分類
- iCloud同期
- エクスポート機能（共有）

### 11.4 分析機能
- ピッチ精度の評価
- スコアリング
- 進捗グラフ
- 練習履歴カレンダー

## 12. 成功指標（MVP）

### 12.1 技術指標
- スケール再生が途切れず完了する
- 録音が正常に保存される
- 録音ファイルが正常に再生できる
- クラッシュが発生しない

### 12.2 ユーザビリティ指標
- 初回ユーザーが説明なしで録音できる
- 録音から再生までスムーズに実行できる
- エラーメッセージが理解しやすい

## 13. 技術スタック

### 13.1 開発環境
- **Xcode**: 15.0以上
- **Swift**: 5.9以上
- **iOS**: 15.0以上

### 13.2 フレームワーク
- **UI**: SwiftUI
- **オーディオ**: AVFoundation (AVAudioEngine, AVAudioUnitSampler, AVAudioRecorder)
- **リアクティブ**: Combine
- **永続化**: FileManager + UserDefaults

### 13.3 アーキテクチャ
- **Clean Architecture**: ドメイン層・アプリケーション層・インフラ層・プレゼンテーション層
- **Domain-Driven Design**: エンティティと値オブジェクトでドメインモデリング
- **MVVM**: プレゼンテーション層のパターン
- **Dependency Injection**: DIコンテナで依存関係を管理

## 14. 開発スケジュール（参考）

- **Week 1-2**: アーキテクチャ設計、ドメインモデル実装
- **Week 3-4**: スケール音源生成・再生機能
- **Week 5-6**: 録音機能実装
- **Week 7-8**: 録音リスト・再生機能、UIブラッシュアップ
- **Week 9**: テスト、バグ修正
- **Week 10**: MVP完成、内部テスト開始

## 付録A: 用語集

| 用語 | 説明 |
|-----|------|
| スケール | 音階。本アプリでは5音階（ドレミファソ） |
| ピッチ | 音の高さ。MIDI番号で表現（C4=60） |
| レガート | 音を途切れさせず滑らかに繋げる演奏法 |
| MIDI | 電子楽器の演奏データを扱う規格 |
| AVFoundation | Appleのマルチメディアフレームワーク |
| AAC | 音声圧縮フォーマット |

## 付録B: 参考資料

- [AVAudioEngine - Apple Developer](https://developer.apple.com/documentation/avfaudio/avaudioengine)
- [AVAudioUnitSampler - Apple Developer](https://developer.apple.com/documentation/avfaudio/avaudiounitsampler)
- [AVAudioRecorder - Apple Developer](https://developer.apple.com/documentation/avfaudio/avaudiorecorder)
