# 分析ページ仕様書 (AnalysisView Specification)

## ドキュメント情報
- **作成日**: 2025年10月17日
- **バージョン**: 1.0
- **対象**: MVP実装

## 1. 概要

分析ページ (AnalysisView) は、録音ファイルのピッチ分析とスペクトログラムを表示し、ユーザーが歌唱の精度を視覚的に確認できる画面です。

### 主要機能
- ピッチ分析グラフ（時系列）
- スペクトログラム（ヒートマップ）
- 録音の再生コントロール
- 再生位置と連動したグラフ表示

## 2. 画面操作フロー

### 2.1 画面遷移
```
録音リスト → 録音を選択 → AnalysisView表示
                           ↓
                     [ローディング]
                           ↓
                     分析処理実行（バックグラウンド）
                           ↓
                     分析完了 → 結果表示
                           ↓
                     再生可能状態
```

### 2.2 ステート管理

```swift
enum AnalysisState {
    case loading                             // 分析中
    case ready(result: AnalysisResult)       // 分析完了・表示可能
    case error(message: String)              // エラー発生
}
```

#### ステート遷移
1. **初期状態**: `loading`
   - ローディングインジケーター表示
   - 分析処理開始

2. **分析完了**: `loading` → `ready`
   - グラフ表示
   - 再生コントロール有効化

3. **エラー発生**: `loading` → `error`
   - エラーメッセージ表示
   - リトライボタン表示

### 2.3 処理時間目標
- **分析処理**: 1-2秒以内
- **処理が長引く場合**: 進捗表示を追加検討

## 3. ピッチ分析グラフ仕様

### 3.1 表示方式

```
┌──────────────────────────────────────────┐
│ ピッチ分析                               │
├──────────────────────────────────────────┤
│ Hz                                       │
│ 500 ┬ ─ ─ ─ ソ      ← 目標音階         │
│ 400 ┼ ─ ─ ─ ファ                        │
│ 350 ┼    ●─●─●●●  ← 検出ピッチ（流れる）│
│ 300 ┼ ─ ─ ─ ミ                          │
│ 250 ┼ ─ ─ ─ レ                          │
│ 200 ┴ ─ ─ ─ ド                          │
│     ←─────────────┃                     │
│     古い         現在                     │
│                  ┃ ← 固定された再生位置  │
└──────────────────────────────────────────┘
```

### 3.2 表示要素

#### 縦軸（周波数）
- **範囲**: 録音のスケール設定に応じて動的設定
- **目盛り**: 目標音階（ド、レ、ミ、ファ、ソ）の周波数位置
- **表示**: Hz単位 + 音名表記

#### 横軸（時間）
- **スクロール方式**: 右から左へ流れる（方式A）
- **表示ウィンドウ**: 最新の6秒間（調整可能）
- **再生位置**: 右端に固定された縦線

#### 目標音階ライン
- **表示**: 水平破線
- **色**: グレー（#888888）
- **位置**: 各スケール音の周波数

#### 検出ピッチライン
- **表示**: 実線 + ドット
- **色分け**:
  - 緑（#00CC00）: 目標音に近い（±20セント以内）
  - 黄（#FFCC00）: ややずれている（±20～50セント）
  - 赤（#FF3333）: 大きくずれている（±50セント以上）
- **ドットサイズ**: 4pt
- **線の太さ**: 2pt

### 3.3 動作仕様

#### 再生連動
1. 再生開始 → グラフが右から左に流れ始める
2. 再生位置線（右端）は固定
3. 新しいピッチデータが右端に追加
4. 古いデータは左に流れて表示範囲外へ

#### データサンプリング
- **サンプリング間隔**: 0.05秒ごと
- **データポイント数（2分30秒）**: 約3,000ポイント

## 4. スペクトログラム仕様

### 4.1 表示方式

```
┌──────────────────────────────────────────┐
│ スペクトログラム            ↑縦スクロール│
├──────────────────────────────────────────┤
│ 2000Hz ▓░░▓▓░▓  ← カラフルヒートマップ │
│ 1500Hz ░▓▓░░▓░                          │
│ 1000Hz ▓▓░░▓░░  （スクロール可能）     │
│  500Hz ░░▓▓░░▓                          │
│  200Hz ░░░▓░░░                          │
│        ←──────┃                         │
│        古い  現在                         │
└──────────────────────────────────────────┘
```

### 4.2 表示要素

#### ヒートマップ
- **色マッピング**:
  - 青（#0000FF）: 弱い（0-25%）
  - 緑（#00FF00）: 中程度（25-50%）
  - 黄（#FFFF00）: 強い（50-75%）
  - 赤（#FF0000）: 非常に強い（75-100%）
- **解像度**:
  - 周波数: 20段階以上
  - 時間: 0.1秒刻み

#### 周波数範囲
- **全体範囲**: 80Hz～2000Hz（ボーカル範囲）
- **初期表示**: 80Hz～800Hz
- **縦スクロール**: ユーザーが手動で上下にスクロール可能

#### 時間軸
- **スクロール方式**: 右から左へ流れる（方式A）
- **表示ウィンドウ**: 最新の6秒間（ピッチグラフと同期）
- **再生位置**: 右端に固定された縦線

### 4.3 動作仕様

#### 再生連動
- ピッチグラフと同じタイミングでスクロール
- 再生位置線も右端で固定

#### 縦スクロール
- ユーザーがスワイプ操作で上下スクロール
- スクロール範囲: 80Hz～2000Hz
- 表示ウィンドウ: 約700Hz幅

#### データサンプリング
- **サンプリング間隔**: 0.1秒ごと
- **周波数ビン数**: 20段階
- **データサイズ（2分30秒）**: 約120KB

## 5. 再生コントロール仕様

### 5.1 コントロール要素

```
┌─────────────────────────────────┐
│ 再生コントロール                │
├─────────────────────────────────┤
│ [◀◀]  [▶/⏸]  [▶▶]            │
│                                 │
│ ●━━━━━━━━━━━━━━━━━━━━━        │
│ 00:15                    02:30  │
└─────────────────────────────────┘
```

### 5.2 機能

- **再生/一時停止**: トグルボタン
- **早戻し**: -5秒
- **早送り**: +5秒
- **シークバー**: タップまたはドラッグで任意の位置にジャンプ
- **時間表示**: 現在時刻 / 合計時間

### 5.3 動作

- 再生中: グラフが流れる
- 一時停止: グラフの流れが停止
- シーク: 該当位置のデータから表示再開

## 6. データ構造

### 6.1 分析結果データ

```swift
struct AnalysisResult {
    let pitchData: PitchAnalysisData
    let spectrogramData: SpectrogramData
    let scaleSettings: ScaleSettings?
}
```

### 6.2 ピッチ分析データ

```swift
struct PitchAnalysisData {
    let timeStamps: [Double]        // 時刻（秒）
    let frequencies: [Float]        // 検出周波数（Hz）
    let confidences: [Float]        // 信頼度 0.0-1.0
    let targetNotes: [MIDINote?]    // 目標音（スケールありの場合）
}
```

**データ例**:
```
timeStamps:   [0.00, 0.05, 0.10, 0.15, ...]
frequencies:  [261.6, 262.3, 261.9, 293.7, ...]  // Hz
confidences:  [0.85, 0.92, 0.88, 0.91, ...]
targetNotes:  [C4, C4, C4, D4, ...]
```

### 6.3 スペクトログラムデータ

```swift
struct SpectrogramData {
    let timeStamps: [Double]        // 時刻（秒）
    let frequencyBins: [Float]      // 周波数ビン（Hz）
    let magnitudes: [[Float]]       // [時間][周波数] の2次元配列
}
```

**データ例**:
```
timeStamps:    [0.0, 0.1, 0.2, 0.3, ...]
frequencyBins: [80, 180, 280, 380, ..., 2000]  // 20段階
magnitudes:    [
  [0.1, 0.3, 0.8, 0.5, ...],  // t=0.0s の各周波数強度
  [0.2, 0.4, 0.7, 0.6, ...],  // t=0.1s
  ...
]
```

## 7. キャッシュ戦略

### 7.1 インメモリキャッシュ

```swift
class AnalysisCache {
    private var cache: [RecordingId: AnalysisResult] = [:]
    private let maxCacheSize = 10  // 最大10件

    func get(_ id: RecordingId) -> AnalysisResult?
    func set(_ id: RecordingId, result: AnalysisResult)
    func clear()
}
```

### 7.2 キャッシュ仕様

- **保存先**: メモリ内のみ（永続化なし）
- **有効期間**: アプリセッション内
- **最大件数**: 10件（LRU方式で古いものから削除）
- **再起動後**: キャッシュクリア、再分析が必要

### 7.3 メリット・デメリット

**メリット**:
- 実装が最速
- ストレージ消費ゼロ
- セッション内では高速アクセス

**デメリット**:
- アプリ再起動後は再分析必要（1-2秒）
- メモリ使用量の管理が必要

### 7.4 将来の拡張

- **永続化キャッシュ**: 別ファイル保存方式（`recording_xxx_analysis.json`）
- **クラウド同期**: 将来的にiCloud同期を検討

## 8. 分析処理フロー

### 8.1 処理シーケンス

```
1. 画面表示
   ↓
2. キャッシュ確認
   - あり → すぐに表示（ステップ6へ）
   - なし → 分析処理開始
   ↓
3. 音声ファイル読み込み (AVAudioFile)
   ↓
4. ピッチ分析実行 (RealtimePitchDetector使用)
   - 0.05秒ごとにサンプリング
   - FFT + HPS法でピッチ検出
   ↓
5. スペクトル分析実行 (FFT)
   - 0.1秒ごとにサンプリング
   - 20周波数帯域の強度計算
   ↓
6. 分析結果をキャッシュに保存
   ↓
7. 結果表示（ステート: ready）
   ↓
8. 再生コントロール有効化
```

### 8.2 エラーハンドリング

- **ファイル読み込み失敗**: エラーメッセージ + リトライボタン
- **分析処理失敗**: エラーメッセージ + リトライボタン
- **メモリ不足**: キャッシュクリア → 再試行

## 9. レイアウト仕様

### 9.1 横画面（推奨）

```
┌────────────────────────────────────────────────────────┐
│ [<] 録音分析                                            │
├────────────────────────────────────────────────────────┤
│  左側: 情報・コントロール  │  右側: グラフ表示         │
│ ┌──────────────────┐      │ ┌────────────────────────┐│
│ │ 録音情報          │      │ │  スペクトログラム      ││
│ │ 日時: 10/14 15:30│      │ │  [ヒートマップ]        ││
│ │ 長さ: 2:30       │      │ │                        ││
│ └──────────────────┘      │ └────────────────────────┘│
│                           │ ┌────────────────────────┐│
│ ┌──────────────────┐      │ │  ピッチ分析グラフ      ││
│ │ 再生コントロール  │      │ │  [時系列グラフ]        ││
│ │ [◀◀][▶/⏸][▶▶]  │      │ │                        ││
│ │ ━●━━━━━━━━━━     │      │ └────────────────────────┘│
│ └──────────────────┘      │                           │
└────────────────────────────────────────────────────────┘
```

- **左側幅**: 240-280pt
- **右側**: 残り全幅
- **上下比率**: スペクトル 50% / ピッチ 50%

### 9.2 縦画面（サブ対応）

```
┌───────────────────────────┐
│ [<] 録音分析               │
├───────────────────────────┤
│ 録音情報（コンパクト版）  │
│ 10/14 15:30 | 2:30        │
├───────────────────────────┤
│ 再生コントロール          │
│ [◀◀] [▶/⏸] [▶▶]        │
│ ━●━━━━━━ 00:15 / 02:30   │
├───────────────────────────┤
│ スペクトログラム          │
│ [200pt高さ]               │
├───────────────────────────┤
│ ピッチ分析                │
│ [200pt高さ]               │
└───────────────────────────┘
```

- **スクロール可能**: 縦にスクロールして全体を表示

## 10. 非機能要件

### 10.1 パフォーマンス

- **分析処理時間**: 1-2秒以内（2分30秒の録音）
- **描画フレームレート**: 30fps以上
- **メモリ使用量**: 1録音あたり最大2MB
- **キャッシュサイズ**: 最大10録音で約20MB

### 10.2 品質

- **ピッチ検出精度**: ±10セント以内（理想）
- **スペクトル解像度**: 周波数20段階、時間0.1秒刻み
- **UI応答性**: タップから0.1秒以内に反応

## 11. MVP対象外機能（将来バージョン）

以下の機能はMVPには含まず、将来バージョンで検討:

### 分析関連
- スコアリング機能（精度の点数化）
- 音階ごとの統計情報
- ピッチの安定度分析
- ビブラートの検出

### 表示関連
- ズーム機能（時間軸・周波数軸）
- グラフの比較表示（複数録音）
- エクスポート機能（画像・PDF）

### データ管理
- 分析結果の永続化（ファイル保存）
- iCloud同期
- 分析設定のカスタマイズ

## 12. 技術スタック

### 12.1 使用フレームワーク

- **SwiftUI**: UI実装
- **AVFoundation**: 音声ファイル読み込み、再生
- **Accelerate**: FFT処理（vDSP）
- **Combine**: リアクティブプログラミング

### 12.2 既存コンポーネント活用

- **RealtimePitchDetector**: ピッチ検出ロジック再利用
  - FFT + HPS法による高精度検出
  - 既にテスト済み

## 13. 参考資料

- **画面設計書**: `docs/SCREEN_DESIGN_V2.md`
- **既存実装**: `VocalisStudio/Presentation/Views/AnalysisView.swift`
- **ピッチ検出器**: `VocalisStudio/Infrastructure/Audio/RealtimePitchDetector.swift`
- **MVP仕様書**: `docs/MVP_SPECIFICATION.md`

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-10-17 | 1.0 | 初版作成（画面操作フロー、表示仕様、データ構造を定義）|
