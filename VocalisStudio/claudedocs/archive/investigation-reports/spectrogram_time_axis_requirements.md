# スペクトログラム時間軸スクロール要件書（簡潔・正確版）

**作成日**: 2025-11-14
**ステータス**: 正式版

---

## 1. 概要

スペクトログラム表示の**時間軸（横方向）**に関する表示およびスクロール挙動を定義する。

**基本コンセプト**:
- 赤線（再生カーソル）は常に**画面中央に固定**
- 録音データ（スペクトログラム）は再生に応じて**左方向へ流れる**
- 時間軸のラベル帯は**画面下部に固定**
- 赤線の真下に常に**現在の再生時刻**が位置する

---

## 2. 表示構成

| 領域 | 内容 | スクロール方向 |
|------|------|----------------|
| 周波数ラベル列（左） | 縦軸目盛（0Hz〜最大周波数） | 縦方向のみ追従 |
| スペクトログラム本体 | 時間×周波数の描画領域 | 横方向に流れ、縦方向にスクロール可 |
| 時間ラベル帯（下部） | 横軸目盛（0s, 1s, 2s...） | 横方向にスペクトログラムと同期、縦方向固定 |

---

## 3. 基本原則

### 3.1 スケール固定
- 時間あたりの描画幅（例：1秒＝50px）は**常に一定**
- 表示モード変更（通常⇔フルスクリーン）でも変化しない

### 3.2 赤線固定
- 再生カーソル（赤線）は**画面中央に静止**
- 再生に合わせてスペクトログラムが**左方向へ流れる**

### 3.3 時間軸位置
- 時間軸ラベル帯は常に**画面下端**にある
- 赤線の真下に**現在時刻ラベル**が来る

### 3.4 ラベル同期
- 時間ラベルはスペクトログラムと**完全に同期**して横方向に流れる
- 縦方向には動かない（画面下端に固定）

---

## 4. 初期状態（再生開始前、currentTime = 0）

### 4.1 視覚的配置

```
┌─────────────────────────────────────────────────────┐
│ ビューポート                                          │
│                                                      │
│ [グレー余白]      0s   1s   2s   3s   4s   5s      │
│                   ↑                                  │
│                紙の左端                               │
│                                                      │
│         画面中央（赤線）                              │
│            ↓                                         │
│            ┃ ← 赤線（固定）                          │
│         0sラベルが赤線真下                            │
└─────────────────────────────────────────────────────┘
```

### 4.2 状態

1. 赤線は画面中央に位置する
2. **「0秒」ラベルが赤線の真下に表示される**
3. 赤線より左側には録音データが存在しない領域（グレー余白）がある
4. 赤線より右側に録音データが続く
5. スペクトログラムは静止しており、時間軸ラベル帯も固定

---

## 5. 再生中の挙動（0 < currentTime < durationSec）

### 5.1 基本動作

1. 再生の進行に合わせて**スペクトログラムが左方向に流れる**
2. 赤線は中央に静止したまま
3. 赤線下の時間ラベルが「現在の再生時刻」を示す

### 5.2 可視範囲

- **原則**: 「現在時刻 ±（画面幅に相当する時間の半分）」
- **制約**: 録音冒頭・終端ではその範囲が録音全体に制限される

**例**: 3秒経過時（画面幅が十分な場合）
- 録音冒頭（0〜3s）が画面内に含まれる
- 赤線下に「3s」ラベルが表示される
- 0sラベルは赤線より左側に見える

### 5.3 視覚的イメージ（currentTime = 3s）

```
┌─────────────────────────────────────────────────────┐
│ ビューポート                                          │
│                                                      │
│ [余白]  0s   1s   2s   3s   4s   5s   6s   7s      │
│         ↑              ↑                             │
│      紙の左端      画面中央（赤線）                    │
│                       ↓                              │
│                       ┃ ← 赤線（固定）               │
│                    3sラベルが赤線真下 ✅              │
└─────────────────────────────────────────────────────┘
```

---

## 6. 再生終端の挙動（currentTime = durationSec）

### 6.1 状態

1. 録音の最後の瞬間、**スペクトログラムの右端が赤線に到達**
2. それ以上スペクトログラムは左へ流れない
3. 赤線の真下に**録音終了時刻ラベル**（例：10s）が表示される
4. 赤線より右側は録音データのない空白領域となる

### 6.2 視覚的イメージ（currentTime = 10s）

```
┌─────────────────────────────────────────────────────┐
│ ビューポート                                          │
│                                                      │
│ 4s   5s   6s   7s   8s   9s  10s  [空白]           │
│                         ↑    ↑                      │
│                    画面中央  紙の右端                 │
│                      ↓                               │
│                      ┃ ← 赤線（固定）                │
│                   10sラベルが赤線真下 ✅              │
└─────────────────────────────────────────────────────┘
```

---

## 7. 縦方向スクロール

### 7.1 周波数軸のスクロール

- スペクトログラム本体と周波数ラベル列で**同期**して行われる
- 時間ラベル帯は縦方向に動かず、常に**画面下端に固定**

### 7.2 重要な制約

時間ラベル帯（画面下部）は、縦軸スクロールの影響を**一切受けない**。

---

## 8. フルスクリーン切替時

### 8.1 変化する要素

- 画面幅が広がる
- 赤線の位置も新しい**中央**に再配置される
- 可視範囲が拡大

### 8.2 変化しない要素

- 再生位置（時刻）
- 時間スケール（1秒あたりの幅 = 50px）
- 動作原理

### 8.3 結果

画面に見える範囲が拡大するのみで、動作原理は同一。

---

## 9. 短い録音の場合（durationSec < 画面幅相当の時間）

### 9.1 初期状態

- 録音全体が画面幅より短い
- 赤線右側に空白領域が存在
- 0sラベルが赤線下に表示

### 9.2 再生終端

- 再生が進むと右端が赤線に到達し、終端で停止
- どの時点でも赤線下に正しい時刻が表示される

---

## 10. 受け入れ基準

### 10.1 視覚的検証項目

| 検証項目 | 合格条件 |
|----------|----------|
| **初期表示** | 「0s」ラベルが赤線下にあり、左側に余白がある |
| **再生中** | 赤線は中央に静止。スペクトログラムが左へ流れ、赤線下のラベルが現在時刻を示す |
| **終端** | 録音終了時、右端が赤線に一致して停止。赤線下に終了時刻ラベルがある |
| **縦スクロール** | 時間ラベル帯は上下に動かない。周波数ラベルは上下に追従 |
| **フルスクリーン** | 時間スケール不変、再生位置不変 |

### 10.2 定量的検証（ログベース）

#### 検証1: 初期表示（currentTime = 0）

**条件**:
```
赤線X座標 = viewportWidth / 2
0sラベルX座標（画面内） = 赤線X座標
許容誤差: ±1.0 px
```

#### 検証2: 再生中（例: currentTime = 3s）

**条件**:
```
赤線X座標 = viewportWidth / 2
3sラベルX座標（画面内） = 赤線X座標
許容誤差: ±1.0 px
```

#### 検証3: 録音終端（currentTime = durationSec）

**条件**:
```
赤線X座標 = viewportWidth / 2
終端ラベルX座標（画面内） = 赤線X座標
許容誤差: ±1.0 px
```

---

## 11. 要件の本質（実装者への指針）

### 11.1 不変の真理

1. **赤線は常に中央に固定される**
2. **時間軸は画面下端にあり、赤線下に現在時刻ラベルが来る**
3. **録音の進行はスペクトログラムが左へ流れることで表現される**
4. **初期状態では紙の左端が赤線に接し、終端時には右端が赤線に接する**

### 11.2 要素ごとの挙動

| 要素 | X方向 | Y方向 |
|------|-------|-------|
| スペクトログラム本体 | 左へ流れる（再生に連動） | スクロール可能 |
| 周波数ラベル | 固定（左列） | スクロール可能（本体と同期） |
| 時間ラベル | 本体と同期して流れる | 固定（画面下端） |
| 再生カーソル（赤線） | 固定（画面中央） | 固定（画面全高） |

### 11.3 座標系の考え方

**キャンバス座標系**（データ全体）:
- X: 0s位置 = 0px, 1s位置 = 50px, 2s位置 = 100px, ...
- Y: 最大周波数 = 0px, 0Hz = canvasHeight

**ビューポート座標系**（画面表示）:
- 赤線X = viewportWidth / 2（固定）
- 時間ラベル帯Y = viewportHeight - labelHeight（固定）

**スクロールによる変換**:
- 現在時刻tの位置がビューポート中央（赤線下）に来るように、キャンバスを左へシフト

---

## 12. 実装のチェックポイント

### 12.1 必須実装項目

- [ ] 赤線は画面中央に固定表示
- [ ] 初期状態（t=0）で0sラベルが赤線下
- [ ] 再生中、赤線下に常に現在時刻ラベル
- [ ] スペクトログラムが左方向に流れる
- [ ] 時間ラベルがスペクトログラムと同期
- [ ] 時間ラベル帯は縦スクロールの影響を受けない
- [ ] 録音終端で右端が赤線に到達して停止

### 12.2 禁止事項

- ❌ 赤線を動かす（常に中央固定）
- ❌ 時間ラベル帯を縦方向に動かす（下端固定）
- ❌ 時間スケールを変更する（1秒=50px固定）
- ❌ スペクトログラムを右方向に流す（左のみ）

---

## 13. 用語集

| 用語 | 説明 |
|------|------|
| `currentTime` | 現在の再生時刻 [秒] |
| `durationSec` | 録音の総時間 [秒] |
| `pixelsPerSecond` | 時間スケール（例: 50 px/s） |
| `viewportWidth` | ビューポートの幅 [px] |
| `viewportHeight` | ビューポートの高さ [px] |
| `canvasWidth` | スペクトログラム全体の幅 = `durationSec × pixelsPerSecond` |
| `canvasHeight` | スペクトログラム全体の高さ（周波数範囲による） |
| `playheadX` | 赤線のX座標 = `viewportWidth / 2` |
| `紙` | スペクトログラムの描画領域全体 |
| `流れる` | 再生に伴い左方向にシフトする動き |

---

**重要**: この要件書は実装の指針であり、細かい実装方法（`paperLeft`などの変数名や計算式）は含まない。実装者は、この要件を満たすための最適な実装を選択すること。
