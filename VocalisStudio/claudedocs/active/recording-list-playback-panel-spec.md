# 録音一覧 - 固定再生コントロールパネル仕様書

## 概要

録音一覧画面のUXを改善し、各行の再生コントロールを画面下部の固定パネルに集約する。

## 現状の課題

- 各録音行に再生ボタンとスライダーがあり、UIが複雑
- 複数の録音間を比較する際に操作が煩雑
- 一般的な音楽プレイヤーのUXと異なり、直感的でない

## 参考にしたUXパターン

- **Apple Music / Spotify** - 画面下部に固定されたミニプレイヤー
- **SoundCloud** - 選択した曲のコントロールパネル
- **YouTube Music** - コンパクトな固定パネル

---

## 画面構成

```
┌─────────────────────────────┐
│  録音一覧（ナビゲーション）    │
├─────────────────────────────┤
│                             │
│  📅 2024/01/15 14:30        │  ← 選択中（再生中）ハイライト
│  ドレミファソ (C4)           │
│  ⏱ 0:35                    │
│  [分析] [削除]              │
│                             │
│  📅 2024/01/15 14:20        │  ← 通常状態
│  ドレミファソファミレド (A3)   │
│  ⏱ 0:48                    │
│  [分析] [削除]              │
│                             │
├─────────────────────────────┤
│  🎵 固定再生コントロールパネル  │
│  ┌─────────────────────┐   │
│  │ ドレミファソ (C4)      │   │
│  │ 2024/01/15 14:30     │   │
│  │                      │   │
│  │ ◀◀   ▶/⏸   ▶▶     │   │
│  │ ─●───────── 0:12/0:35│   │
│  └─────────────────────┘   │
└─────────────────────────────┘
```

---

## 一覧行の仕様

### 表示項目

| 項目 | 説明 | 備考 |
|------|------|------|
| 日時 | 録音日時（フォーマット済み） | 現状維持 |
| スケール名 | スケール表示名 | 現状維持 |
| 再生時間 | Duration（秒数をMM:SS形式で表示） | 現状維持 |
| 分析ボタン | 分析画面へ遷移 | 現状維持 |
| 削除ボタン | 削除確認ダイアログ表示 | 現状維持 |

### 削除する項目

- ~~再生/停止ボタン~~ → パネルに移動
- ~~シークスライダー~~ → パネルに移動
- ~~経過時間表示~~ → パネルに移動

### 状態表示

| 状態 | 視覚的フィードバック |
|------|---------------------|
| 通常 | 標準の背景色 |
| 選択中（再生中） | ハイライト背景色（アクセントカラー薄め） |
| 選択中（停止中） | ハイライト背景色（選択状態を維持） |

### インタラクション

| 操作 | 挙動 |
|------|------|
| タップ | 録音を選択し、即座に再生開始 |
| 分析ボタン | 分析画面へ遷移（再生は停止） |
| 削除ボタン | 削除確認ダイアログ表示 |

---

## 固定再生コントロールパネルの仕様

### 表示条件

- **録音が存在する場合**: 常に表示
- **録音が存在しない場合**: 非表示（空状態表示のみ）
- **録音未選択時**: パネル表示、「録音を選択してください」メッセージ

### 表示項目

| 項目 | 説明 |
|------|------|
| 録音情報 | スケール名 + 日時 |
| 前へボタン | 一覧の前の録音に移動して再生 |
| 再生/一時停止ボタン | 再生状態をトグル |
| 次へボタン | 一覧の次の録音に移動して再生 |
| シークスライダー | 再生位置の表示と操作 |
| 時間表示 | 経過時間 / 総時間（MM:SS形式） |

### コントロールボタン

```
    ◀◀        ▶/⏸        ▶▶
  [前へ]   [再生/停止]   [次へ]
```

- **前へ（◀◀）**: 一覧の前の録音を選択して再生
  - 先頭の場合は無効化（グレーアウト）
- **再生/一時停止（▶/⏸）**:
  - 停止中: 再生開始
  - 再生中: 一時停止
- **次へ（▶▶）**: 一覧の次の録音を選択して再生
  - 末尾の場合は無効化（グレーアウト）

### 状態管理

```swift
// ViewModel で管理する状態
@Published var selectedRecording: Recording?     // 選択中の録音
@Published var isPlaying: Bool = false           // 再生中かどうか
@Published var currentPosition: TimeInterval = 0 // 再生位置
```

### インタラクション詳細

| 操作 | 挙動 |
|------|------|
| 再生ボタンタップ | 選択中の録音を再生/一時停止 |
| 前へボタンタップ | 前の録音を選択して再生開始 |
| 次へボタンタップ | 次の録音を選択して再生開始 |
| スライダー操作 | 再生位置をシーク |
| 再生終了 | 停止状態を維持（自動で次へは移動しない） |

---

## 状態遷移

### 初期状態
- 録音未選択
- パネル表示（「録音を選択してください」）
- 再生ボタン無効化

### 録音選択時
1. ユーザーが録音行をタップ
2. `selectedRecording` を更新
3. 即座に再生開始
4. 行をハイライト表示
5. パネルに録音情報を表示

### 別の録音選択時
1. 現在の再生を停止
2. 新しい録音を選択
3. 新しい録音の再生を開始
4. ハイライトを移動

### 再生終了時
1. `isPlaying` を `false` に
2. 選択状態は維持
3. スライダーは終了位置を維持

### 削除時
1. 選択中の録音を削除した場合
   - 選択を解除
   - パネルを未選択状態に
2. 別の録音を削除した場合
   - 選択状態を維持

---

## アクセシビリティ

### VoiceOver対応

| 要素 | ラベル |
|------|--------|
| 録音行 | 「{スケール名}、{日時}、{再生時間}」 |
| 選択中の行 | 「選択中、{スケール名}...」 |
| 再生中の行 | 「再生中、{スケール名}...」 |
| 再生ボタン | 「再生」/「一時停止」 |
| 前へボタン | 「前の録音」 |
| 次へボタン | 「次の録音」 |
| スライダー | 「再生位置、{経過時間}/{総時間}」 |

### 視覚的フィードバック

- 選択状態: 背景色変更（ColorPalette.primary.opacity(0.1)）
- 再生中: アイコン変更（▶ → ⏸）
- 無効状態: グレーアウト + タップ無効

---

## 将来の拡張（スコープ外）

以下は本仕様には含まないが、将来検討する機能：

- ファイル名の表示と編集
- パネルの展開（詳細情報表示）
- 波形プレビュー表示
- シャッフル/リピート機能
- バックグラウンド再生対応

---

## 実装タスク

### ViewModel変更
- [ ] `selectedRecording: Recording?` を追加
- [ ] `playingRecordingId` を `isPlaying: Bool` に変更（または併用）
- [ ] `selectAndPlay(_ recording: Recording)` メソッド追加
- [ ] `playPrevious()` メソッド追加
- [ ] `playNext()` メソッド追加
- [ ] `togglePlayback()` メソッド追加

### View変更
- [ ] `RecordingRow` から再生コントロールを削除
- [ ] `RecordingRow` に選択状態のハイライトを追加
- [ ] `PlaybackControlPanel` コンポーネントを新規作成
- [ ] `RecordingListView` にパネルを配置（ZStack + VStack）

### テスト
- [ ] ViewModel のユニットテスト追加
- [ ] UIテスト追加（選択、再生、前へ/次へ）

---

## Accessibility Identifiers

```swift
// 録音行
"RecordingRow_{uuid}"
"RecordingRow_{uuid}_selected"  // 選択状態

// パネル
"PlaybackControlPanel"
"PlaybackControlPanel_RecordingInfo"
"PlaybackControlPanel_PreviousButton"
"PlaybackControlPanel_PlayPauseButton"
"PlaybackControlPanel_NextButton"
"PlaybackControlPanel_Slider"
"PlaybackControlPanel_CurrentTime"
"PlaybackControlPanel_TotalTime"
```

---

## 関連ファイル

- `VocalisStudio/Presentation/Views/RecordingListView.swift`
- `VocalisStudio/Presentation/ViewModels/RecordingListViewModel.swift`
- `VocalisStudioTests/Presentation/ViewModels/RecordingListViewModelTests.swift`
- `VocalisStudioUITests/RecordingListUITests.swift`
