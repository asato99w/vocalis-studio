# vocadito歌唱データセット ピッチ検出精度評価レポート

## 実行日時
2025-10-21

## 評価概要

### テスト対象
- **アルゴリズム**: RealtimePitchDetector (FFT + HPS: Harmonic Product Spectrum)
- **データセット**: vocadito singing voice dataset
- **評価サンプル数**: 30サンプル (10トラック × 各3ノート)
- **評価方法**: ノート中心点でのピッチ検出 vs グラウンドトゥルースアノテーション

### 評価基準
- **誤差閾値**: 50 cents (半音以下)
- **信頼度閾値**: 0.5以上
- **合格条件**: 両基準を満たすこと

## 総合結果

### 統計サマリー
| 指標 | 値 |
|------|-----|
| 総サンプル数 | 30 |
| 合格数 (誤差<50cents) | 23 (76.7%) |
| 不合格数 | 7 (23.3%) |
| 信頼度≥0.5のサンプル数 | 30 (100.0%) |
| 平均誤差 | 72.4 cents |
| 最小誤差 | 6.7 cents |
| 最大誤差 | 1161.7 cents |
| 平均信頼度 | 1.000 |

### 合格率
- **誤差基準**: 76.7% (23/30)
- **信頼度基準**: 100.0% (30/30)
- **両基準**: 76.7% (23/30)

## 詳細分析

### 1. 不合格ノートの詳細

| ノート | 期待値 (Hz) | 検出値 (Hz) | 誤差 (cents) | 信頼度 | エラー分類 |
|--------|------------|------------|-------------|--------|-----------|
| Track10_Note1 | 104.58 | 204.60 | 1161.7 | 1.000 | オクターブエラー |
| Track1_Note2 | 158.44 | 151.01 | 83.2 | 1.000 | 高周波数バイアス |
| Track4_Note2 | 144.39 | 150.52 | 72.0 | 1.000 | 高周波数バイアス |
| Track5_Note3 | 268.24 | 279.92 | 73.8 | 1.000 | 高周波数バイアス |
| Track8_Note1 | 135.25 | 139.97 | 59.3 | 1.000 | 高周波数バイアス |
| Track8_Note3 | 125.06 | 129.14 | 55.6 | 1.000 | 高周波数バイアス |
| Track9_Note1 | 154.46 | 161.14 | 73.3 | 1.000 | 高周波数バイアス |

### 2. エラーパターン分析

#### オクターブエラー (1件)
- **Track10_Note1**: 104.58 Hz → 204.60 Hz (誤差1161.7 cents)
- **原因推定**: 低周波数帯域(~100 Hz)でのF0推定の失敗。倍音を基本周波数と誤認識。
- **重大度**: 極めて高い（約1オクターブのずれは音楽的に許容不可）

#### 高周波数バイアス (6件)
- **範囲**: 55.6 - 83.2 cents
- **パターン**: すべてのケースで実際より高い周波数を検出
- **周波数帯域**: 125 - 268 Hz (主に男性ボーカル帯域)
- **原因推定**: FFT+HPSアルゴリズムの系統的バイアス、またはウィンドウサイズの不適切さ

### 3. 周波数帯域別の精度

| 周波数帯域 | サンプル数 | 合格数 | 合格率 | 平均誤差 |
|-----------|-----------|--------|--------|---------|
| 低周波 (<150 Hz) | 8 | 4 | 50.0% | 214.8 cents |
| 中低周波 (150-200 Hz) | 8 | 5 | 62.5% | 45.1 cents |
| 中高周波 (200-300 Hz) | 14 | 14 | 100.0% | 22.4 cents |

**発見**:
- 低周波数帯域で精度が著しく低下
- 200 Hz以上では100%の合格率
- 中高周波数帯域が最も安定した検出精度

### 4. 信頼度スコアの問題

**観察結果**:
- 全30サンプルで信頼度が1.000 (100%)
- 不合格の7サンプルも同様に信頼度100%

**問題点**:
- 現在の信頼度メトリクスは実際の検出精度と相関していない
- オクターブエラーのような重大な失敗でも高信頼度を示す
- 実用上、信頼度スコアがユーザーへのフィードバックとして機能していない

## 改善ポイント

### 優先度1: オクターブエラーの修正
**問題**: 低周波数帯域(~100 Hz)で1オクターブ上を検出
**改善案**:
1. HPSアルゴリズムのハーモニック次数を調整
2. サブハーモニック検出の追加
3. 低周波数用の適応的FFTウィンドウサイズ
4. 事前フィルタリングによる倍音抑制

### 優先度2: 高周波数バイアスの軽減
**問題**: 系統的に実際より高い周波数を検出(55-85 cents)
**改善案**:
1. ピーク検出アルゴリズムの見直し
2. 適応的な補正係数の導入
3. ピーク補間手法の改善(放物線補間の精度向上)
4. 周波数帯域別の補正テーブル作成

### 優先度3: 信頼度メトリクスの改善
**問題**: 信頼度が実際の精度と相関していない
**改善案**:
1. スペクトラムピークの明瞭度を考慮
2. HPS結果の一貫性チェック
3. 周波数帯域別の信頼度調整
4. 複数フレームでの安定性評価

### 優先度4: 周波数帯域別の最適化
**問題**: 低周波数帯域での精度低下(50.0%合格率)
**改善案**:
1. 周波数帯域別のFFTウィンドウサイズ
2. 低周波数用の長いフレーム長
3. 適応的なHPSパラメータ
4. ゼロクロッシング法との併用検討

## 次のステップ

### 短期 (1-2週間)
1. オクターブエラーの原因特定と修正
2. 低周波数帯域での精度改善
3. 信頼度メトリクスの再設計

### 中期 (1-2ヶ月)
1. 高周波数バイアスの補正
2. 周波数帯域別最適化の実装
3. 拡張評価(より多くのサンプル)

### 長期 (3ヶ月以降)
1. 機械学習ベースのF0推定の検討
2. リアルタイム性能とのトレードオフ評価
3. 実ユーザーフィードバックに基づく改善

## テスト実装詳細

### テストファイル
- `VocalisStudioTests/Infrastructure/Audio/VocaditoAccuracyEvaluationTests.swift`

### テスト構成
- 30個の独立実行可能なテストメソッド
- トラック1-10、各3ノート
- 各テストはXcodeから個別実行可能

### 実行コマンド
```bash
# 全テスト実行
xcodebuild test -project VocalisStudio/VocalisStudio.xcodeproj \
  -scheme VocalisStudio \
  -destination 'platform=iOS Simulator,name=iPhone 16' \
  -only-testing:VocalisStudioTests/VocaditoAccuracyEvaluationTests \
  -allowProvisioningUpdates

# 個別テスト実行例
xcodebuild test -project VocalisStudio/VocalisStudio.xcodeproj \
  -scheme VocalisStudio \
  -destination 'platform=iOS Simulator,name=iPhone 16' \
  -only-testing:VocalisStudioTests/VocaditoAccuracyEvaluationTests/testTrack1_Note1 \
  -allowProvisioningUpdates
```

### 結果ファイル
- `/tmp/vocadito_pitch_results.txt` - 詳細な検出結果
- `/tmp/analyze_results.py` - 統計分析スクリプト

## 参考資料

### データセット
- **vocadito**: 40トラックの歌唱音声データセット
- **アノテーション**: F0およびノートレベルの正解データ
- **形式**: WAV (44.1kHz) + CSV

### 関連ファイル
- `VocalisStudio/VocalisStudioTests/Infrastructure/Audio/VocaditoAnnotationParserTests.swift`
- `dataset/vocadito/Annotations/Notes/*.csv`
- `dataset/vocadito/Audio/*.wav`

## まとめ

現在のRealtimePitchDetector (FFT+HPS)は、200 Hz以上の中高周波数帯域では高精度(100%合格率)を示していますが、以下の課題があります:

1. **低周波数帯域の精度低下**: 150 Hz未満で50%の合格率
2. **オクターブエラー**: ~100 Hzで重大な誤検出
3. **系統的バイアス**: 55-85 centsの高周波数寄りの誤差
4. **信頼度メトリクスの無効性**: 100%信頼度でも不合格

これらの問題に対処することで、実用的なピッチ検出精度を達成できると考えられます。特に優先度1のオクターブエラーは音楽的に許容できないため、早急な対応が必要です。
